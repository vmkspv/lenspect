on:
  push:
    branches: [main]
  pull_request:
name: AppImage
jobs:
  appimage:
    name: "Build AppImage"
    container:
      image: ubuntu:25.10
    strategy:
      matrix:
        variant:
          - arch: x86_64
            runner: ubuntu-24.04
          - arch: aarch64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.variant.runner }}
    steps:
      - name: Install dependencies
        run: |
          apt update
          apt install -y --no-install-recommends \
            git ca-certificates curl file libfuse2t64 \
            meson ninja-build gettext blueprint-compiler desktop-file-utils appstream \
            python3 python3-gi python3-gi-cairo \
            libglib2.0-dev libgtk-4-dev libadwaita-1-dev libsoup-3.0-dev libsecret-1-dev
      - uses: actions/checkout@v6
      - name: Build application
        run: |
          meson setup builddir --prefix=/usr
          meson compile -C builddir
          DESTDIR=$PWD/AppDir meson install -C builddir
      - name: Prepare AppDir
        run: |
          PY_VER=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
          ARCH_TRIPLET="${{ matrix.variant.arch }}-linux-gnu"
          glib-compile-schemas AppDir/usr/share/glib-2.0/schemas/
          mkdir -p AppDir/usr/lib/python3 AppDir/usr/lib/${ARCH_TRIPLET} AppDir/usr/share/icons/Adwaita
          cp /usr/bin/python3 AppDir/usr/bin/
          cp -a /usr/lib/python${PY_VER} AppDir/usr/lib/
          cp -a /usr/lib/python3/dist-packages AppDir/usr/lib/python3/
          cp -a /usr/lib/${ARCH_TRIPLET}/girepository-1.0 AppDir/usr/lib/${ARCH_TRIPLET}/
          cp /usr/share/icons/Adwaita/index.theme AppDir/usr/share/icons/Adwaita/
          cp -a /usr/share/icons/Adwaita/scalable /usr/share/icons/Adwaita/symbolic AppDir/usr/share/icons/Adwaita/ 2>/dev/null || true
          sed -i "s|pkgdatadir = '/usr/share/lenspect'|import os; pkgdatadir = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'share', 'lenspect')|" AppDir/usr/bin/lenspect
          sed -i "s|localedir = '/usr/share/locale'|localedir = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'share', 'locale')|" AppDir/usr/bin/lenspect
          cat > AppDir/AppRun << EOF
          #!/bin/sh
          APPDIR="\$(dirname "\$(readlink -f "\$0")")"
          ARCH_TRIPLET=\$(ls -d "\${APPDIR}"/usr/lib/*-linux-gnu 2>/dev/null | head -n1 | xargs basename)
          export LD_LIBRARY_PATH="\${APPDIR}/usr/lib:\${APPDIR}/usr/lib/\${ARCH_TRIPLET}:\${LD_LIBRARY_PATH:-}"
          export PYTHONHOME="\${APPDIR}/usr"
          export PYTHONPATH="\${APPDIR}/usr/lib/python3/dist-packages:\${APPDIR}/usr/lib/python${PY_VER}"
          export GI_TYPELIB_PATH="\${APPDIR}/usr/lib/\${ARCH_TRIPLET}/girepository-1.0"
          export GSETTINGS_SCHEMA_DIR="\${APPDIR}/usr/share/glib-2.0/schemas"
          export XDG_DATA_DIRS="\${APPDIR}/usr/share:\${XDG_DATA_DIRS:-/usr/share}"
          exec "\${APPDIR}/usr/bin/python3" "\${APPDIR}/usr/bin/lenspect" "\$@"
          EOF
          chmod +x AppDir/AppRun
      - name: Create AppImage
        env:
          APPIMAGE_EXTRACT_AND_RUN: 1
          NO_STRIP: 1
        run: |
          curl -sL -o linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${{ matrix.variant.arch }}.AppImage
          chmod +x linuxdeploy
          ARCH_TRIPLET="${{ matrix.variant.arch }}-linux-gnu"
          OUTPUT=lenspect.AppImage ./linuxdeploy \
            --appdir AppDir \
            --library /usr/lib/${ARCH_TRIPLET}/libgtk-4.so.1 \
            --library /usr/lib/${ARCH_TRIPLET}/libadwaita-1.so.0 \
            --library /usr/lib/${ARCH_TRIPLET}/libsoup-3.0.so.0 \
            --desktop-file AppDir/usr/share/applications/io.github.vmkspv.lenspect.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/scalable/apps/io.github.vmkspv.lenspect.svg \
            --output appimage
      - uses: actions/upload-artifact@v6
        with:
          name: lenspect-${{ matrix.variant.arch }}.AppImage
          path: lenspect.AppImage